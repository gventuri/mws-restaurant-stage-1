let restaurant;var map;'serviceWorker'in navigator&&window.addEventListener('load',function(){navigator.serviceWorker.register('sw.js').then(function(a){document.getElementById('submitReview').addEventListener('click',()=>{navigator.onLine?sendReview():window.addEventListener('online',sendReview)}),console.log('ServiceWorker registration successful with scope: ',a.scope)}).catch(function(a){console.log('ServiceWorker registration failed: ',a)})}),sendReview=()=>{const a={restaurant_id:window.restaurant.id,name:document.getElementById('formName').value,rating:document.getElementById('formScore').value,comments:document.getElementById('formReview').value};fetch('http://localhost:1337/reviews/',{method:'POST',body:JSON.stringify(a)}).then(function(b){if(!b.ok)throw Error(b.statusText);return b.json()}).then(function(b){console.log(b);let c=window.indexedDB.open('MyDatabase',Date.now());c.onsuccess=d=>{addReview(b,d.db)},window.location.reload()}).catch(function(b){console.log(b)})},document.addEventListener('DOMContentLoaded',()=>{window.initMap=()=>{let b=window.indexedDB.open('MyDatabase',1);b.onerror=function(){console.log('Error connecting to the db')},b.onupgradeneeded=function(c){window.db=c.target.result;const d=window.db.createObjectStore('restaurants',{keyPath:'id'}),f=window.db.createObjectStore('reviews',{keyPath:'id'})},b.onsuccess=function(c){window.db=c.target.result;let d=window.db.transaction('restaurants').objectStore('restaurants');d.openCursor().onsuccess=function(g){let h=g.target.result;h?(h.value.id==getParameterByName('id')&&(window.restaurant=h.value),h.continue()):fetchRestaurantFromURL(j=>{j?console.error(j):(self.map=new google.maps.Map(document.getElementById('map'),{zoom:16,center:window.restaurant.latlng,scrollwheel:!1}),fillBreadcrumb(),DBHelper.mapMarkerForRestaurant(window.restaurant,self.map))})};let f=window.db.transaction('reviews').objectStore('reviews');f.openCursor().onsuccess=function(g){let h=g.target.result;h&&(!window.reviews&&(window.reviews=[]),window.reviews.push(h.value),h.continue())}}}}),fetchRestaurantFromURL=a=>{if(window.restaurant)return console.log('Already fetched',window.restaurant),fillRestaurantHTML(),void a(null,restaurant);const b=getParameterByName('id');b?DBHelper.fetchRestaurantById(b,(c,d)=>{return window.restaurant=d,d?void(fillRestaurantHTML(),a(null,d)):void console.error(c)}):(error='No restaurant id in URL',a(error,null))},fillRestaurantHTML=a=>{a||(a=window.restaurant);const b=document.getElementById('restaurant-name');b.innerHTML=a.name;const c=document.getElementById('restaurant-address');c.innerHTML=a.address;const d=document.getElementById('restaurant-img');d.className='restaurant-img';let f=DBHelper.imageUrlForRestaurant(a),g=DBHelper.imageUrlForRestaurant(a,'sm');d.setAttribute('data-src',g),d.setAttribute('data-srcset',`${f} 800w, ${g} 300w`),d.setAttribute('alt',`Photo of the restaurant "${b.innerHTML}"`);const h=document.getElementById('restaurant-cuisine');h.innerHTML=a.cuisine_type;let j='';j='true'==a.is_favorite?`<button type='button' onclick='toggleFavorite(false)'>Remove from favorite</button>`:`<button type='button' onclick='toggleFavorite(true)'>Add to favorite</button>`,document.getElementById('favorite').innerHTML=j,a.operating_hours&&fillRestaurantHoursHTML();new LazyLoad;fillReviewsHTML()},toggleFavorite=a=>{console.log(`http://localhost:1337/restaurants/${window.restaurant.id}/?is_favorite=${a?'true':'false'}`),fetch(`http://localhost:1337/restaurants/${window.restaurant.id}/?is_favorite=${a?'true':'false'}`,{method:'PUT'}).then(b=>{return b.json()}).then(b=>{const c=window.db.transaction(['restaurants'],'readwrite').objectStore('restaurants').put(b);console.log('The final res is ',b.is_favorite),c.onsuccess=function(d){console.log('ok',d),window.location.reload()},c.onerror=function(d){console.log('Error adding:',d)}})},fillRestaurantHoursHTML=(a=self.restaurant.operating_hours)=>{const b=document.getElementById('restaurant-hours');for(let c in a){const d=document.createElement('tr'),f=document.createElement('td');f.innerHTML=c,d.appendChild(f);const g=document.createElement('td');g.innerHTML=a[c],d.appendChild(g),b.appendChild(d)}},fillReviewsHTML=()=>{window.setTimeout(function(){if(window.reviews){window.reviews.filter(c=>{return c.restaurant_id==window.restaurant.id})}0<[].length?(console.log('dfafsdfsdfsdf',reviews),_fillReviewsHTML()):(console.log('NO'),fetch('http://localhost:1337/reviews/?restaurant_id='+window.restaurant.id).then(function(b){if(200===b.status)return b.json()}).then(function(b){for(let c in window.reviews=b,b)addReview(window.reviews[c],window.db);_fillReviewsHTML()}))},300)},_fillReviewsHTML=()=>{const a=window.reviews;console.log(a);const b=document.getElementById('reviews-container'),c=document.createElement('h4');if(c.className+=' h2',c.innerHTML='Reviews',b.appendChild(c),!a){const f=document.createElement('p');return f.innerHTML='No reviews yet!',void b.appendChild(f)}const d=document.getElementById('reviews-list');a.forEach(f=>{console.log(f.restaurant_id,'and',window.restaurant.id),f.restaurant_id==window.restaurant.id&&d.appendChild(createReviewHTML(f))}),b.appendChild(d)},createReviewHTML=a=>{const b=document.createElement('li'),c=document.createElement('h4');c.innerHTML=a.name,c.className='review-author',b.appendChild(c);const d=document.createElement('div');d.className='review-body',b.appendChild(d);const f=document.createElement('p'),g=new Date(a.createdAt);f.innerHTML=g.getDate()+'/'+g.getMonth()+'/'+g.getFullYear(),d.appendChild(f);const h=document.createElement('p');let j='';for(let l=0;l<a.rating;l++)j+='&#9733; ';h.innerHTML=`<div class='review-stars' aria-label="Rating from ${a.name}: ${a.rating} stars">${j}</div>`,d.appendChild(h);const k=document.createElement('p');return k.innerHTML=a.comments,d.appendChild(k),b},fillBreadcrumb=(a=self.restaurant)=>{const b=document.getElementById('breadcrumb'),c=document.createElement('li');c.setAttribute('aria-current','page'),c.innerHTML=a.name,b.appendChild(c)},getParameterByName=(a,b)=>{b||(b=window.location.href),a=a.replace(/[\[\]]/g,'\\$&');const c=new RegExp(`[?&]${a}(=([^&#]*)|&|#|$)`),d=c.exec(b);return d?d[2]?decodeURIComponent(d[2].replace(/\+/g,' ')):'':null};function isOnline(){document.getElementById('connectionStatus');document.getElementById('connectionError').style.display=navigator.onLine?'none':'block'}window.addEventListener('online',isOnline),window.addEventListener('offline',isOnline),isOnline(),window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,window.indexedDB||console.log('This browser doesn\'t support IndexedDB');function add2DB(a,b){window.request=b.transaction(['restaurants'],'readwrite').objectStore('restaurants').add(a),window.request.onsuccess=function(){console.log('The restaurant has been added to the db')},window.request.onerror=function(){console.log('Unable to add to the db')}}function addReview(a,b){console.log('Review added'),window.request=b.transaction(['reviews'],'readwrite').objectStore('reviews').add(a),window.request.onsuccess=function(){console.log('The review has been added to the db')},window.request.onerror=function(){console.log('Unable to add to the db')}}